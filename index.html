import logging
import sqlite3
import json
import urllib.parse
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = "8323334700:AAFnB-6COcv2Kb67mRhx9K8tOSxytF9PnlQ"
WEBAPP_URL = "https://basqa-webapptest3.vercel.app/"
BRAND_SITE_URL = "https://basqa.kz/cart"

def init_db():
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cart (
            user_id INTEGER,
            product_id INTEGER,
            product_name TEXT,
            price REAL,
            size TEXT,
            quantity INTEGER,
            PRIMARY KEY (user_id, product_id, size)
        )
    ''')
    conn.commit()
    conn.close()

def add_to_cart(user_id, product_id, product_name, price, size, quantity=1):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT quantity FROM cart WHERE user_id = ? AND product_id = ? AND size = ?",
                   (user_id, product_id, size))
    result = cursor.fetchone()
    
    if result:
        new_quantity = result[0] + quantity
        cursor.execute("UPDATE cart SET quantity = ? WHERE user_id = ? AND product_id = ? AND size = ?",
                       (new_quantity, user_id, product_id, size))
    else:
        cursor.execute("INSERT INTO cart (user_id, product_id, product_name, price, size, quantity) VALUES (?, ?, ?, ?, ?, ?)",
                       (user_id, product_id, product_name, price, size, quantity))
    
    conn.commit()
    conn.close()

def get_cart(user_id):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT product_id, product_name, price, size, quantity FROM cart WHERE user_id = ?", (user_id,))
    items = cursor.fetchall()
    conn.close()
    return [{"product_id": item[0], "product_name": item[1], "price": item[2], "size": item[3], "quantity": item[4]} for item in items]

def clear_cart(user_id):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM cart WHERE user_id = ?", (user_id,))
    conn.commit()
    conn.close()

def remove_from_cart(user_id, product_id, size):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM cart WHERE user_id = ? AND product_id = ? AND size = ?", (user_id, product_id, size))
    conn.commit()
    conn.close()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    await update.message.reply_text(
        f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {user.first_name}! ðŸ‘‹\n\n"
        f"Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð¾Ñ‚ Ð±Ñ€ÐµÐ½Ð´Ð° BASQA.\n"
        f"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ Ð½Ð¸Ð¶Ðµ:",
        reply_markup=get_main_menu()
    )

def get_main_menu():
    keyboard = [
        [InlineKeyboardButton("ðŸ‘• ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³", web_app=WebAppInfo(url=WEBAPP_URL))],
        [InlineKeyboardButton("ðŸ›’ ÐœÐ¾Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°", callback_data="cart")],
        [InlineKeyboardButton("ðŸ…±ï¸ Ðž Ð±Ñ€ÐµÐ½Ð´Ðµ", callback_data="about")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    
    if query.data == "cart":
        await show_cart(update, context)
    elif query.data == "about":
        await show_about(update, context)
    elif query.data.startswith("remove_"):
        parts = query.data.split("_")
        product_id = int(parts[1])
        size = parts[2]
        remove_from_cart(query.from_user.id, product_id, size)
        await show_cart(update, context)
    elif query.data == "checkout":
        await checkout(update, context)
    elif query.data == "main_menu":
        await query.edit_message_text(
            text="Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ BASQA:",
            reply_markup=get_main_menu()
        )

async def show_cart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    cart_items = get_cart(user_id)
    
    if not cart_items:
        await query.edit_message_text(
            text="Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°.\n\nÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹!",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ðŸ‘• ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³", web_app=WebAppInfo(url=WEBAPP_URL))],
                [InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]
            ])
        )
        return
    
    total = sum(item["price"] * item["quantity"] for item in cart_items)
    cart_text = "ðŸ›’ *Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°:*\n\n"
    
    for item in cart_items:
        cart_text += f"â€¢ *{item['product_name']}*\n"
        cart_text += f"  Ð Ð°Ð·Ð¼ÐµÑ€: {item['size']}\n"
        cart_text += f"  ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾: {item['quantity']} ÑˆÑ‚.\n"
        cart_text += f"  Ð¦ÐµÐ½Ð°: {item['price'] * item['quantity']:,.0f} â‚¸\n\n"
    
    cart_text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    cart_text += f"*Ð˜Ð¢ÐžÐ“Ðž: {total:,.0f} â‚¸*"
    
    keyboard = []
    for item in cart_items:
        keyboard.append([InlineKeyboardButton(
            f"âŒ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ {item['product_name']} ({item['size']})", 
            callback_data=f"remove_{item['product_id']}_{item['size']}"
        )])
    
    keyboard.append([InlineKeyboardButton("ðŸ’³ ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·", callback_data="checkout")])
    keyboard.append([InlineKeyboardButton("ðŸ‘• ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸", web_app=WebAppInfo(url=WEBAPP_URL))])
    keyboard.append([InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")])
    
    await query.edit_message_text(
        text=cart_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def checkout(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    cart_items = get_cart(user_id)
    
    if not cart_items:
        await query.edit_message_text(
            text="Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°ÐºÐ°Ð·Ð°.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]])
        )
        return
    
    total = sum(item["price"] * item["quantity"] for item in cart_items)
    
    order_text = "ðŸ“‹ *Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°:*\n\n"
    for item in cart_items:
        order_text += f"â€¢ {item['product_name']} ({item['size']}) x{item['quantity']}\n"
    order_text += f"\nðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾: {total:,.0f} â‚¸*\n\n"
    order_text += "Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð° Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ°Ð¹Ñ‚ BASQA:"
    
    items_param = []
    for item in cart_items:
        items_param.append(f"{item['product_id']}:{item['size']}:{item['quantity']}")
    items_string = ",".join(items_param)
    checkout_url = f"{BRAND_SITE_URL}?items={urllib.parse.quote(items_string)}"
    
    keyboard = [
        [InlineKeyboardButton("ðŸŒ ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸ÑŽ", url=checkout_url)],
        [InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ", callback_data="cart")]
    ]
    
    await query.edit_message_text(
        text=order_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_about(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    about_text = (
        "â„¹ï¸ *Ðž Ð±Ñ€ÐµÐ½Ð´Ðµ BASQA*\n\n"
        "BASQA â€” ÐºÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½ÑÐºÐ¸Ð¹ streetwear-Ð±Ñ€ÐµÐ½Ð´ Ñ Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„Ð¸ÐµÐ¹ \"Another Vision\".\n\n"
        "ÐœÑ‹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð´ÐµÐ¶Ð´Ñƒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¾Ñ‚Ñ€Ð°Ð¶Ð°ÐµÑ‚ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð³Ð¾Ñ€Ð¾Ð´ÑÐºÑƒÑŽ ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ñƒ ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½Ð°, "
        "ÑÐ¾Ñ‡ÐµÑ‚Ð°Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚Ñ€ÐµÐ½Ð´Ð°Ð¼Ð¸.\n\n"
        "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ Ð¾ Ð½Ð°Ñ Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð½Ð° Qazmonitor Ð¸ Ð² ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐµÑ‚ÑÑ… BASQA."
    )
    
    keyboard = [[InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]]
    
    await query.edit_message_text(
        text=about_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    data = json.loads(update.effective_message.web_app_data.data)
    user_id = update.effective_user.id
    
    if data.get("action") == "checkout" and "cart" in data:
        cart_data = data["cart"]
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
        clear_cart(user_id)
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸Ð· Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        for item in cart_data:
            add_to_cart(
                user_id, 
                item["product_id"], 
                item["name"], 
                item["price"], 
                item["size"],
                item["quantity"]
            )
        
        total = sum(item["price"] * item["quantity"] for item in cart_data)
        
        order_text = "âœ… *Ð—Ð°ÐºÐ°Ð· Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½!*\n\n"
        order_text += "ðŸ“‹ Ð¡Ð¾ÑÑ‚Ð°Ð² Ð·Ð°ÐºÐ°Ð·Ð°:\n\n"
        for item in cart_data:
            order_text += f"â€¢ {item['name']} ({item['size']}) x{item['quantity']}\n"
        order_text += f"\nðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾: {total:,.0f} â‚¸*\n\n"
        order_text += "Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ°Ð¹Ñ‚:"
        
        items_param = []
        for item in cart_data:
            items_param.append(f"{item['product_id']}:{item['size']}:{item['quantity']}")
        items_string = ",".join(items_param)
        checkout_url = f"{BRAND_SITE_URL}?items={urllib.parse.quote(items_string)}"
        
        keyboard = [
            [InlineKeyboardButton("ðŸŒ ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·", url=checkout_url)],
            [InlineKeyboardButton("ðŸ›’ ÐœÐ¾Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°", callback_data="cart")],
            [InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")]
        ]
        
        await update.message.reply_text(
            text=order_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )

def main() -> None:
    init_db()
    application = Application.builder().token(TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, web_app_data))
    
    application.run_polling()

if __name__ == "__main__":
    main()
