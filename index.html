import logging
import sqlite3
import json
import urllib.parse
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = "8323334700:AAFnB-6COcv2Kb67mRhx9K8tOSxytF9PnlQ"
WEBAPP_URL = "https://basqa-webapptest3.vercel.app/"
BRAND_SITE_URL = "https://basqa.kz/cart"

# ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
SUPPORT_PHONE = "77051234567"  # Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ WhatsApp
SUPPORT_MESSAGE = "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð£ Ð¼ÐµÐ½Ñ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ Ð±Ð¾Ñ‚Ñƒ BASQA"

def init_db():
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS cart (
            user_id INTEGER,
            product_id INTEGER,
            product_name TEXT,
            price REAL,
            size TEXT,
            quantity INTEGER,
            PRIMARY KEY (user_id, product_id, size)
        )
    ''')
    conn.commit()
    conn.close()

def add_to_cart(user_id, product_id, product_name, price, size, quantity=1):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT quantity FROM cart WHERE user_id = ? AND product_id = ? AND size = ?",
                   (user_id, product_id, size))
    result = cursor.fetchone()
    if result:
        new_quantity = result[0] + quantity
        cursor.execute("UPDATE cart SET quantity = ? WHERE user_id = ? AND product_id = ? AND size = ?",
                       (new_quantity, user_id, product_id, size))
    else:
        cursor.execute("INSERT INTO cart (user_id, product_id, product_name, price, size, quantity) VALUES (?, ?, ?, ?, ?, ?)",
                       (user_id, product_id, product_name, price, size, quantity))
    conn.commit()
    conn.close()

def get_cart(user_id):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT product_id, product_name, price, size, quantity FROM cart WHERE user_id = ?", (user_id,))
    items = cursor.fetchall()
    conn.close()
    return [{"product_id": item[0], "product_name": item[1], "price": item[2], "size": item[3], "quantity": item[4]} for item in items]

def clear_cart(user_id):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM cart WHERE user_id = ?", (user_id,))
    conn.commit()
    conn.close()

def remove_from_cart(user_id, product_id, size):
    conn = sqlite3.connect('basqa_bot.db')
    cursor = conn.cursor()
    cursor.execute("DELETE FROM cart WHERE user_id = ? AND product_id = ? AND size = ?", (user_id, product_id, size))
    conn.commit()
    conn.close()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    await update.message.reply_text(
        f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {user.first_name}! ðŸ‘‹\n\n"
        f"Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð¾Ñ‚ Ð±Ñ€ÐµÐ½Ð´Ð° BASQA.\n"
        f"Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ Ð½Ð¸Ð¶Ðµ:",
        reply_markup=get_main_menu()
    )

def get_main_menu():
    keyboard = [
        [InlineKeyboardButton("ðŸ‘• ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³", web_app=WebAppInfo(url=WEBAPP_URL))],
        [
            InlineKeyboardButton("ðŸ›’ ÐœÐ¾Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°", callback_data="cart"),
            InlineKeyboardButton("ðŸ‘¤ ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ", callback_data="user_panel")
        ],
        [
            InlineKeyboardButton("ðŸ…±ï¸ Ðž Ð±Ñ€ÐµÐ½Ð´Ðµ", callback_data="about"),
            InlineKeyboardButton("ðŸ‘ï¸â€ðŸ—¨ï¸ Basqa Room", callback_data="basqa_room")
        ],
        [InlineKeyboardButton("ðŸ’¬ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°", callback_data="support")]
    ]
    return InlineKeyboardMarkup(keyboard)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    
    if query.data == "cart":
        await show_cart(update, context)
    elif query.data == "about":
        await show_about(update, context)
    elif query.data.startswith("remove_"):
        parts = query.data.split("_")
        product_id = int(parts[1])
        size = parts[2]
        remove_from_cart(query.from_user.id, product_id, size)
        await show_cart(update, context)
    elif query.data == "checkout":
        await checkout(update, context)
    elif query.data == "main_menu":
        await query.edit_message_text(
            text="Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ BASQA:",
            reply_markup=get_main_menu()
        )
    elif query.data == "user_panel":
        await show_user_panel(update, context)
    elif query.data == "basqa_room":
        await show_basqa_room(update, context)
    elif query.data == "support":
        await show_support(update, context)

async def show_cart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    cart_items = get_cart(user_id)
    
    if not cart_items:
        await query.edit_message_text(
            text="Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°.\n\nÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹!",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ðŸ‘• ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³", web_app=WebAppInfo(url=WEBAPP_URL))],
                [InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]
            ])
        )
        return
    
    total = sum(item["price"] * item["quantity"] for item in cart_items)
    cart_text = "ðŸ›’ *Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°:*\n\n"
    for item in cart_items:
        cart_text += f"â€¢ *{item['product_name']}*\n"
        cart_text += f"  Ð Ð°Ð·Ð¼ÐµÑ€: {item['size']}\n"
        cart_text += f"  ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾: {item['quantity']} ÑˆÑ‚.\n"
        cart_text += f"  Ð¦ÐµÐ½Ð°: {item['price'] * item['quantity']:,.0f} â‚¸\n\n"
    
    cart_text += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    cart_text += f"*Ð˜Ð¢ÐžÐ“Ðž: {total:,.0f} â‚¸*"
    
    keyboard = []
    for item in cart_items:
        keyboard.append([InlineKeyboardButton(
            f"âŒ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ {item['product_name']} ({item['size']})",
            callback_data=f"remove_{item['product_id']}_{item['size']}"
        )])
    
    keyboard.append([InlineKeyboardButton("ðŸ’³ ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·", callback_data="checkout")])
    keyboard.append([InlineKeyboardButton("ðŸ‘• ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸", web_app=WebAppInfo(url=WEBAPP_URL))])
    keyboard.append([InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")])
    
    await query.edit_message_text(
        text=cart_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def checkout(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    cart_items = get_cart(user_id)
    
    if not cart_items:
        await query.edit_message_text(
            text="Ð’Ð°ÑˆÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°ÐºÐ°Ð·Ð°.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]])
        )
        return
    
    total = sum(item["price"] * item["quantity"] for item in cart_items)
    order_text = "ðŸ“‹ *Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°:*\n\n"
    for item in cart_items:
        order_text += f"â€¢ {item['product_name']} ({item['size']}) x{item['quantity']}\n"
    
    order_text += f"\nðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾: {total:,.0f} â‚¸*\n\n"
    order_text += "Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð° Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ°Ð¹Ñ‚ BASQA:"
    
    items_param = []
    for item in cart_items:
        items_param.append(f"{item['product_id']}:{item['size']}:{item['quantity']}")
    items_string = ",".join(items_param)
    checkout_url = f"{BRAND_SITE_URL}?items={urllib.parse.quote(items_string)}"
    
    keyboard = [
        [InlineKeyboardButton("ðŸŒ ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸ÑŽ", url=checkout_url)],
        [InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´ Ðº ÐºÐ¾Ñ€Ð·Ð¸Ð½Ðµ", callback_data="cart")]
    ]
    
    await query.edit_message_text(
        text=order_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_about(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    about_text = (
        "â„¹ï¸ *Ðž Ð±Ñ€ÐµÐ½Ð´Ðµ BASQA*\n\n"
        "BASQA â€” ÐºÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½ÑÐºÐ¸Ð¹ streetwear-Ð±Ñ€ÐµÐ½Ð´ Ñ Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„Ð¸ÐµÐ¹ \"Another Vision\".\n\n"
        "ÐœÑ‹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð´ÐµÐ¶Ð´Ñƒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ð¾Ñ‚Ñ€Ð°Ð¶Ð°ÐµÑ‚ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð³Ð¾Ñ€Ð¾Ð´ÑÐºÑƒÑŽ ÐºÑƒÐ»ÑŒÑ‚ÑƒÑ€Ñƒ ÐšÐ°Ð·Ð°Ñ…ÑÑ‚Ð°Ð½Ð°, "
        "ÑÐ¾Ñ‡ÐµÑ‚Ð°Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚Ñ€ÐµÐ½Ð´Ð°Ð¼Ð¸.\n\n"
        "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ Ð¾ Ð½Ð°Ñ Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ·Ð½Ð°Ñ‚ÑŒ Ð½Ð° Qazmonitor Ð¸ Ð² ÑÐ¾Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐµÑ‚ÑÑ… BASQA."
    )
    keyboard = [[InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´", callback_data="main_menu")]]
    await query.edit_message_text(
        text=about_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    data = json.loads(update.effective_message.web_app_data.data)
    user_id = update.effective_user.id
    
    if data.get("action") == "checkout" and "cart" in data:
        cart_data = data["cart"]
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
        clear_cart(user_id)
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸Ð· Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        for item in cart_data:
            add_to_cart(
                user_id,
                item["product_id"],
                item["name"],
                item["price"],
                item["size"],
                item["quantity"]
            )
        
        total = sum(item["price"] * item["quantity"] for item in cart_data)
        order_text = "âœ… *Ð—Ð°ÐºÐ°Ð· Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½!*\n\n"
        order_text += "ðŸ“‹ Ð¡Ð¾ÑÑ‚Ð°Ð² Ð·Ð°ÐºÐ°Ð·Ð°:\n\n"
        for item in cart_data:
            order_text += f"â€¢ {item['name']} ({item['size']}) x{item['quantity']}\n"
        
        order_text += f"\nðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾: {total:,.0f} â‚¸*\n\n"
        order_text += "Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ°Ð¹Ñ‚:"
        
        items_param = []
        for item in cart_data:
            items_param.append(f"{item['product_id']}:{item['size']}:{item['quantity']}")
        items_string = ",".join(items_param)
        checkout_url = f"{BRAND_SITE_URL}?items={urllib.parse.quote(items_string)}"
        
        keyboard = [
            [InlineKeyboardButton("ðŸŒ ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·", url=checkout_url)],
            [InlineKeyboardButton("ðŸ›’ ÐœÐ¾Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ð°", callback_data="cart")],
            [InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")]
        ]
        
        await update.message.reply_text(
            text=order_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )

# ========== ÐÐžÐ’Ð«Ð™ Ð¤Ð£ÐÐšÐ¦Ð˜ÐžÐÐÐ› ==========

async def show_user_panel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ ÐµÐ³Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸"""
    query = update.callback_query
    user = query.from_user
    
    user_info_text = (
        "ðŸ‘¤ *ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ*\n\n"
        f"ðŸ†” ID: `{user.id}`\n"
        f"ðŸ‘¤ Ð˜Ð¼Ñ: {user.first_name}"
    )
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
    if user.last_name:
        user_info_text += f" {user.last_name}"
    
    user_info_text += "\n"
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ username ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
    if user.username:
        user_info_text += f"ðŸ“± Username: @{user.username}\n"
    else:
        user_info_text += f"ðŸ“± Username: Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½\n"
    
    keyboard = [[InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")]]
    
    await query.edit_message_text(
        text=user_info_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_basqa_room(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Basqa Room"""
    query = update.callback_query
    
    basqa_room_text = (
        "ðŸ‘ï¸â€ðŸ—¨ï¸ *BASQA ROOM*\n\n"
        "Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð°Ñ Ð·Ð¾Ð½Ð° Ð±Ñ€ÐµÐ½Ð´Ð° BASQA â€” ÑÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð¸ÑÑ‚Ð¸Ð½Ð½Ñ‹Ñ… Ñ†ÐµÐ½Ð¸Ñ‚ÐµÐ»ÐµÐ¹.\n\n"
        "ðŸ”¥ Ð§Ñ‚Ð¾ Ð²Ð½ÑƒÑ‚Ñ€Ð¸:\n"
        "â€¢ Ð Ð°Ð½Ð½Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð½Ð¾Ð²Ñ‹Ð¼ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑÐ¼\n"
        "â€¢ Ð­ÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ðµ Ð´Ñ€Ð¾Ð¿Ñ‹ Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹\n"
        "â€¢ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²\n"
        "â€¢ Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¼ÐµÑ€Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ñ Ð¸ ÐºÐ¾Ð»Ð»Ð°Ð±Ð¾Ñ€Ð°Ñ†Ð¸Ð¸\n"
        "â€¢ ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ\n\n"
        "ðŸ’Ž BASQA ROOM â€” ÑÑ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½, ÑÑ‚Ð¾ ÐºÐ¾Ð¼ÑŒÑŽÐ½Ð¸Ñ‚Ð¸ ÐµÐ´Ð¸Ð½Ð¾Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ð¸ÐºÐ¾Ð², "
        "ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»ÑÑŽÑ‚ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð±Ñ€ÐµÐ½Ð´Ð° Ð¸ ÑÑ‚Ð¸Ð»ÑŒ Ð¶Ð¸Ð·Ð½Ð¸ Another Vision."
    )
    
    keyboard = [[InlineKeyboardButton("â—€ï¸ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")]]
    
    await query.edit_message_text(
        text=basqa_room_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

async def show_support(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐµ"""
    query = update.callback_query
    
    support_text = (
        "ðŸ’¬ *ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° BASQA*\n\n"
        "ÐÐ°ÑˆÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð²ÑÐµÐ³Ð´Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð²Ð°Ð¼!\n\n"
        "ðŸ“ž Ð¡Ð²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· WhatsApp Ð´Ð»Ñ:\n"
        "â€¢ ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼\n"
        "â€¢ ÐŸÐ¾Ð¼Ð¾Ñ‰Ð¸ Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð¼\n"
        "â€¢ Ð’Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¾ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐµ\n"
        "â€¢ Ð›ÑŽÐ±Ñ‹Ñ… Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²\n\n"
        "â° Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹: ÐŸÐ½-Ð’Ñ, 10:00 - 22:00\n\n"
        "ÐœÑ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð¼ Ð²Ð°Ð¼ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ!"
    )
    
    # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ WhatsApp ÑÑÑ‹Ð»ÐºÑƒ Ñ Ð¿Ñ€ÐµÐ´Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
    whatsapp_url = f"https://wa.me/{SUPPORT_PHONE}?text={urllib.parse.quote(SUPPORT_MESSAGE)}"
    
    keyboard = [
        [InlineKeyboardButton("ðŸ’¬ ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² WhatsApp", url=whatsapp_url)],
        [InlineKeyboardButton("â—€ï¸ ÐÐ°Ð·Ð°Ð´ Ð² Ð¼ÐµÐ½ÑŽ", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        text=support_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )

# ========== ÐšÐžÐÐ•Ð¦ ÐÐžÐ’ÐžÐ“Ðž Ð¤Ð£ÐÐšÐ¦Ð˜ÐžÐÐÐ›Ð ==========

def main() -> None:
    init_db()
    application = Application.builder().token(TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, web_app_data))
    
    application.run_polling()

if __name__ == "__main__":
    main()
